<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>安暖跑酷</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    body{background:#000;overflow:hidden;touch-action:manipulation;user-select:none;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC","Microsoft YaHei",Arial,sans-serif;}
    #root{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#000;}

    #stage{
      position:relative;
      width:min(100vw, 520px);
      height:min(100vh, 920px);
      aspect-ratio: 9 / 16;
      display:flex;align-items:center;justify-content:center;
      padding:
        calc(env(safe-area-inset-top, 0px) + 0px)
        calc(env(safe-area-inset-right, 0px) + 0px)
        calc(env(safe-area-inset-bottom, 0px) + 0px)
        calc(env(safe-area-inset-left, 0px) + 0px);
    }
    canvas{
      width:100%;height:100%;
      display:block;
      background:#102a43;
      image-rendering: pixelated;
      border-radius:0;
    }

    .ui{position:absolute;inset:0;pointer-events:none;}

    .topRight{
      position:absolute;
      top: calc(env(safe-area-inset-top, 0px) + 12px);
      right: calc(env(safe-area-inset-right, 0px) + 12px);
      display:flex;flex-direction:column;gap:8px;
      align-items:flex-end;
      pointer-events:auto;
    }
    .btnRow{display:flex;gap:10px;align-items:center;justify-content:flex-end;}
    .iconBtn{
      width:44px;height:44px;border:none;border-radius:12px;
      background:rgba(255,255,255,.10);
      backdrop-filter: blur(6px);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
      box-shadow:0 6px 18px rgba(0,0,0,.25);
    }
    .iconBtn:active{transform:scale(.98)}
    .iconBtn img{width:28px;height:28px;image-rendering:pixelated;}

    .energyWrap{
      width:220px;
      pointer-events:none;
      transform-origin: 100% 0%;
    }
    .energyWrap.flash{
      animation: energyFlash .25s ease-out 1;
    }
    @keyframes energyFlash{
      0%{transform:scale(1); filter:drop-shadow(0 0 0 rgba(255,215,0,0));}
      60%{transform:scale(1.06); filter:drop-shadow(0 10px 18px rgba(255,215,0,.35));}
      100%{transform:scale(1); filter:drop-shadow(0 6px 12px rgba(0,0,0,.25));}
    }
    .energyFrame{
      width:220px;height:auto;display:block;
      image-rendering:pixelated;
      filter:drop-shadow(0 6px 12px rgba(0,0,0,.25));
    }

    .scoreBox{
      position:absolute;
      top: calc(env(safe-area-inset-top, 0px) + 12px);
      left: calc(env(safe-area-inset-left, 0px) + 12px);
      padding:8px 12px;border-radius:12px;
      background:rgba(0,0,0,.25);
      color:#fff;font-weight:800;letter-spacing:.5px;
      text-shadow:0 2px 6px rgba(0,0,0,.35);
      pointer-events:none;
    }
    .scoreBox .label{font-size:12px;opacity:.85}
    .scoreBox .value{font-size:22px;color:#ffd700}

    .dashWrap{
      position:absolute;
      left: calc(env(safe-area-inset-left, 0px) + 12px);
      bottom: calc(env(safe-area-inset-bottom, 0px) + 12px);
      pointer-events:auto;
    }
    .dashBtn{
      border:none;border-radius:16px;
      padding:14px 18px;min-width:120px;
      color:#fff;font-weight:900;
      background:linear-gradient(45deg,#ff6b6b,#ff8e53);
      box-shadow:0 10px 22px rgba(255,107,107,.25);
      cursor:pointer;
      transform-origin:center;
    }
    .dashBtn:disabled{opacity:.5;cursor:not-allowed;box-shadow:none;animation:none;}
    .dashBtn:active{transform:scale(.99)}
    .dashBtn.ready{
      animation: dashBreath 1.1s ease-in-out infinite;
    }
    @keyframes dashBreath{
      0%,100%{transform:scale(1); filter:drop-shadow(0 0 0 rgba(255,140,80,0));}
      50%{transform:scale(1.04); filter:drop-shadow(0 10px 18px rgba(255,140,80,.25));}
    }

    .panel{
      position:absolute;inset:0;
      display:flex;align-items:center;justify-content:center;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      pointer-events:auto;
    }
    .panel.hidden{display:none;}
    .card{
      width:min(92%, 420px);
      background:rgba(18, 28, 46, .88);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:18px;
      text-align:center;color:#fff;
      box-shadow:0 18px 44px rgba(0,0,0,.35);
    }
    .title{
      font-size:28px;color:#ffd700;font-weight:900;
      text-shadow:0 0 14px rgba(255,215,0,.45);
      margin-bottom:12px;
    }
    .sub{opacity:.9;margin-bottom:12px;line-height:1.6;font-size:14px;}
    .primaryBtn,.ghostBtn{
      width:100%;border:none;border-radius:16px;
      padding:12px 14px;font-size:16px;font-weight:900;
      cursor:pointer;margin-top:10px;
    }
    .primaryBtn{
      background:linear-gradient(45deg,#ff6b6b,#ff8e53);
      color:#fff;box-shadow:0 12px 26px rgba(255,107,107,.22);
    }
    .ghostBtn{
      background:rgba(255,255,255,.10);
      color:#fff;border:1px solid rgba(255,255,255,.18);
    }

    .coverBlock{margin-top:10px;}
    .coverHero{
      width:180px;height:auto;
      image-rendering:pixelated;
      margin:0 auto 10px;
      display:block;
      filter:drop-shadow(0 10px 18px rgba(0,0,0,.35));
    }
    .coverImg{
      width:100%;max-width:380px;height:auto;border-radius:14px;
      image-rendering:pixelated;display:block;margin:0 auto;
    }

    .settingRow{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      background:rgba(255,255,255,.08);
      border-radius:12px;padding:10px 12px;margin-top:10px;
    }
    .toggle{
      width:52px;height:26px;border-radius:26px;background:#777;
      position:relative;cursor:pointer;flex:0 0 auto;
    }
    .toggle::after{
      content:"";width:20px;height:20px;border-radius:50%;
      background:#fff;position:absolute;top:3px;left:3px;
      transition:all .2s ease;
    }
    .toggle.on{background:#1e90ff}
    .toggle.on::after{left:29px}

    .countCard{
      width:220px;padding:22px;
      background:rgba(0,0,0,.25);
      border:none;
    }
    .countText{
      font-size:72px;font-weight:900;color:#ffd700;
      text-shadow:0 0 18px rgba(255,215,0,.55);
      line-height:1;
    }
    .countHint{margin-top:8px;font-size:12px;opacity:.85}

    .toast{
      position:absolute;
      left:50%;
      top: 52%;
      transform:translate(-50%,-50%);
      padding:10px 14px;
      border-radius:14px;
      background:rgba(0,0,0,.35);
      color:#fff;
      font-weight:900;
      letter-spacing:.3px;
      text-shadow:0 2px 8px rgba(0,0,0,.35);
      pointer-events:none;
      backdrop-filter: blur(6px);
      border:1px solid rgba(255,255,255,.12);
      opacity:0;
      transition:opacity .2s ease;
      max-width:min(92%, 420px);
      text-align:center;
    }
    .toast.show{opacity:1;}
  </style>
</head>
<body>
<div id="root">
  <div id="stage">
    <canvas id="game" width="540" height="960"></canvas>

    <div class="ui">
      <div class="panel" id="panelLoading" style="z-index:999;">
        <div class="card" style="width:min(92%,420px);">
          <div class="title" style="font-size:22px;">资源加载中…</div>
          <div class="sub" id="loadingText">0%</div>
          <div style="height:12px;background:rgba(255,255,255,.12);border-radius:999px;overflow:hidden;margin-top:10px;">
            <div id="loadingBar" style="height:100%;width:0%;background:linear-gradient(45deg,#ff6b6b,#ff8e53);"></div>
          </div>
          <div class="sub" id="loadingTip" style="margin-top:10px;opacity:.85;">正在加载贴图，请稍等…</div>
        </div>
      </div>

      <div class="scoreBox">
        <div class="label">分数</div>
        <div class="value" id="scoreText">0</div>
      </div>

      <div class="topRight">
        <div class="btnRow">
          <button class="iconBtn" id="btnPause" title="暂停"><img id="pauseIconImg" alt="暂停"></button>
          <button class="iconBtn" id="btnSettings" title="设置"><img id="settingsIconImg" alt="设置"></button>
          <button class="iconBtn" id="btnSound" title="声音"><img id="soundIconImg" alt="声音"></button>
        </div>
        <div class="energyWrap" id="energyWrap"><img id="energyFrame" class="energyFrame" alt="能量条"></div>
      </div>

      <div class="dashWrap"><button class="dashBtn" id="btnDash" disabled>筋斗云</button></div>
      <div class="toast" id="toast"></div>

      <div class="panel" id="panelStart">
        <div class="card">
          <div class="title">《安暖跑酷》</div>
          <div class="sub">
            分数随跑得更远不断增加<br/>
            桃子：平时只加能量；冲刺时只加额外分<br/>
            点击屏幕跳跃 / 二段跳
          </div>

          <div class="coverBlock">
            <img id="coverHero" class="coverHero" alt="封面大圣">
            <img id="coverImg" class="coverImg" alt="封面背景">
          </div>

          <button class="primaryBtn" id="btnStart">开始游戏</button>
          <button class="ghostBtn" id="btnHow">游戏规则</button>
        </div>
      </div>

      <div class="panel hidden" id="panelHow">
        <div class="card">
          <div class="title" style="font-size:22px;">游戏规则</div>
          <div class="sub" style="text-align:left;">
            • 分数：跑得越远越高（自动增长）<br/>
            • 平时吃桃子：只增加冲刺能量<br/>
            • 冲刺吃桃子：不加能量，额外加分（小桃+10 / 金桃+50）<br/>
            • 能量满可筋斗云：上升→无敌冲刺→自然落下<br/>
            • 冲刺结束后首次落下：临时“三连跳窗口”<br/>
            • 踩到云朵平台后：回到正常二连跳<br/>
            • 掉落屏幕底部失败
          </div>
          <button class="primaryBtn" id="btnBackFromHow">返回</button>
        </div>
      </div>

      <div class="panel hidden" id="panelPause">
        <div class="card">
          <div class="title">暂停</div>
          <button class="primaryBtn" id="btnResume">继续</button>
          <button class="ghostBtn" id="btnRestart">重新开始</button>
          <button class="ghostBtn" id="btnExit">退出</button>
        </div>
      </div>

      <div class="panel hidden" id="panelSettings">
        <div class="card">
          <div class="title" style="font-size:22px;">设置</div>
          <div class="settingRow">
            <div>音效</div>
            <div class="toggle" id="toggleSfx"></div>
          </div>
          <div class="settingRow">
            <div>背景音乐</div>
            <div class="toggle" id="toggleBgm"></div>
          </div>
          <div class="settingRow">
            <div>震动反馈</div>
            <div class="toggle" id="toggleVib"></div>
          </div>
          <button class="primaryBtn" id="btnCloseSettings">返回</button>
        </div>
      </div>

      <div class="panel hidden" id="panelOver">
        <div class="card">
          <div class="title">游戏结束</div>
          <div class="sub">
            得分：<b id="finalScore">0</b>　最高分：<b id="bestScore">0</b><br/>
            距离：<b id="finalDist">0</b>m　冲刺加分：<b id="finalBonus">0</b><br/>
            <span id="diffBest" style="opacity:.9;"></span>
          </div>
          <button class="primaryBtn" id="btnPlayAgain">再玩一次</button>
          <button class="ghostBtn" id="btnShare">分享成绩</button>
          <button class="ghostBtn" id="btnBackMenu">返回主界面</button>
        </div>
      </div>

      <div class="panel hidden" id="panelCountdown" style="background: rgba(0,0,0,.35);">
        <div class="card countCard">
          <div id="countdownText" class="countText">3</div>
          <div class="countHint" id="countdownHint">准备开始</div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
(() => {
  const ASSET_BASE = "./assets/";
  const W = 540, H = 960;

  const GRAVITY = 1700;
  const JUMP_V = 680;
  const EXTRA_JUMP_V = 640;
  const MAX_FALL = 1200;

  const SPEED_MIN = 240;
  const SPEED_MAX = 520;
  const SPEED_UP_SEC = 120;

  const DASH_SPEED = 850;
  const DASH_SEC = 1.8;
  const DASH_RISE = 110;
  const DASH_RISE_SEC = 0.18;

  const DASH_COST = 100;
  const ENERGY_FROM_SMALL = 8;
  const ENERGY_FROM_BIG = 25;

  const DASH_BONUS_SMALL = 10;
  const DASH_BONUS_BIG = 50;

  const PLAYER_W = 64, PLAYER_H = 64;

  // ✅ 只改“显示尺寸”，不改判定：避免竖图被 64x64 压扁
  // - PLAYER_W/PLAYER_H：碰撞判定尺寸（改它会影响难度/手感）
  // - PLAYER_DRAW_H：角色显示高度（改它只影响画面大小）
  // - FOOT_OFFSET：脚底微调（正数=往下贴，负数=往上抬）
  let PLAYER_DRAW_H = 220;   // <- 角色想更大/更小，改这里（建议 180~260）
  let PLAYER_DRAW_W = 140;   // 会根据图片比例自动算
  let FOOT_OFFSET = 0;

  function syncPlayerDrawSize(){
    const img = images.player1 || images.player2 || images.player3;
    if (img && img.width && img.height){
      const ratio = img.width / img.height;
      PLAYER_DRAW_W = Math.max(80, Math.round(PLAYER_DRAW_H * ratio));
    }
  }

  const PLATFORM_H = 46;
  const PLATFORM_MIN_W = 130;
  const PLATFORM_MAX_W = 250;

  const DY_LIMIT = 120;
  function maxGapBySpeed(v){
    if (v < 320) return 220;
    if (v < 420) return 205;
    return 190;
  }
  function minGapBySpeed(v){
    if (v < 320) return 120;
    if (v < 420) return 125;
    return 130;
  }

  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");

  const scoreText = document.getElementById("scoreText");
  const energyFrame = document.getElementById("energyFrame");
  const energyWrap = document.getElementById("energyWrap");

  const panelStart = document.getElementById("panelStart");
  const panelHow = document.getElementById("panelHow");
  const panelPause = document.getElementById("panelPause");
  const panelOver = document.getElementById("panelOver");
  const panelSettings = document.getElementById("panelSettings");
  const panelLoading = document.getElementById("panelLoading");
  const loadingText = document.getElementById("loadingText");
  const loadingBar = document.getElementById("loadingBar");
  const loadingTip = document.getElementById("loadingTip");

  const panelCountdown = document.getElementById("panelCountdown");
  const countdownText = document.getElementById("countdownText");
  const countdownHint = document.getElementById("countdownHint");

  const btnStart = document.getElementById("btnStart");
  const btnHow = document.getElementById("btnHow");
  const btnBackFromHow = document.getElementById("btnBackFromHow");

  const btnPause = document.getElementById("btnPause");
  const btnSettings = document.getElementById("btnSettings");
  const btnSound = document.getElementById("btnSound");

  const btnDash = document.getElementById("btnDash");

  const btnResume = document.getElementById("btnResume");
  const btnRestart = document.getElementById("btnRestart");
  const btnExit = document.getElementById("btnExit");

  const btnCloseSettings = document.getElementById("btnCloseSettings");
  const toggleSfx = document.getElementById("toggleSfx");
  const toggleBgm = document.getElementById("toggleBgm");
  const toggleVib = document.getElementById("toggleVib");

  const btnPlayAgain = document.getElementById("btnPlayAgain");
  const btnShare = document.getElementById("btnShare");
  const btnBackMenu = document.getElementById("btnBackMenu");

  const finalScoreEl = document.getElementById("finalScore");
  const bestScoreEl = document.getElementById("bestScore");
  const finalDistEl = document.getElementById("finalDist");
  const finalBonusEl = document.getElementById("finalBonus");
  const diffBestEl = document.getElementById("diffBest");

  const coverImg = document.getElementById("coverImg");
  const coverHero = document.getElementById("coverHero");

  const pauseIconImg = document.getElementById("pauseIconImg");
  const settingsIconImg = document.getElementById("settingsIconImg");
  const soundIconImg = document.getElementById("soundIconImg");

  const toast = document.getElementById("toast");

  const STATE = { MENU:"menu", COUNTDOWN:"countdown", PLAY:"play", PAUSE:"pause", OVER:"over" };
  let state = STATE.MENU;

  let rafId = null;
  let lastT = 0;

  let distance = 0;
  let score = 0;
  let bonusScore = 0;

  let bestScore = Number(localStorage.getItem("dasheng-best") || 0);

  let timeSec = 0;
  let speed = SPEED_MIN;

  let energy = 0;

  let isDashing = false;
  let dashLeft = 0;
  let dashRiseLeft = 0;
  let dashTargetY = 0;

  let maxJumps = 2;
  let jumpsUsed = 0;
  let tripleWindow = false;

  let sfxOn = localStorage.getItem("dasheng-sfx") !== "0";
  let bgmOn = localStorage.getItem("dasheng-bgm") !== "0";
  let vibOn = localStorage.getItem("dasheng-vib") !== "0";
  toggleSfx.classList.toggle("on", sfxOn);
  toggleBgm.classList.toggle("on", bgmOn);
  toggleVib.classList.toggle("on", vibOn);

  let tutorialDone = localStorage.getItem("dasheng-tutorial-done") === "1";
  let tutorialTimer = 0;
  let tutorialStage = 0;
  function showToast(text){
    toast.textContent = text;
    toast.classList.add("show");
  }
  function hideToast(){
    toast.classList.remove("show");
  }

  const imageSources = {
    background: "背景.jpg",
    coverHero: "猴儿封面.png",

    platformBig: "大云朵.png",
    platformSmall: "小云朵.png",
    peach: "小桃子.png",
    bigPeach: "金桃子.png",

    player1: "猴1.png",
    player2: "猴2.png",
    player3: "猴3.png",

    pauseIcon: "开始icon.png",
    settingsIcon: "设置icon.png",
    soundOn: "声音icon.png",
    soundOff: "静音icon.png",

    energy0:  "冲刺进度条0％.png",
    energy10: "冲刺进度条10％.png",
    energy20: "冲刺进度条20％.png",
    energy30: "冲刺进度条30％.png",
    energy40: "冲刺进度条40％.png",
    energy50: "冲刺进度条50％.png",
    energy60: "冲刺进度条60％.png",
    energy70: "冲刺进度条70％.png",
    energy80: "冲刺进度条80％.png",
    energy90: "冲刺进度条90％.png",
    energy100a: "冲刺进度条100%.png",
    energy100b: "冲刺进度条100％.png",
  };

  const images = {};
  function setLoadingProgress(done,total,key="",ok=true){
    const pct = total ? Math.round((done/total)*100) : 0;
    loadingText.textContent = pct + "%";
    loadingBar.style.width = pct + "%";
    if (key){
      const name = imageSources[key] || key;
      loadingTip.textContent = ok ? `已加载：${name}` : `加载失败：${name}（将用占位显示）`;
    }
  }

  // ✅ 修复点：避免 encodeURI 遇到 % 文件名直接崩溃
  async function loadImages(onProgress){
    const keys = Object.keys(imageSources);
    let done = 0;

    await Promise.all(keys.map((k) => new Promise((resolve) => {
      const img = new Image();

      const finish = (ok) => {
        done++;
        if (onProgress) onProgress(done, keys.length, k, ok);
        resolve();
      };

      let src = "";
      try{
        const file = String(imageSources[k] || "");
        src = ASSET_BASE + encodeURIComponent(file) + "?v=" + Date.now();
      }catch(e){
        console.warn("Bad asset name:", k, imageSources[k], e);
        finish(false);
        return;
      }

      const timer = setTimeout(() => {
        console.warn("Asset load timeout:", k, src);
        finish(false);
      }, 8000);

      img.onload = () => { clearTimeout(timer); images[k]=img; finish(true); };
      img.onerror = () => { clearTimeout(timer); finish(false); };

      img.src = src;
    })));
  }

  let audioCtx = null;
  function beep(freq, dur, type="sine"){
    if (!sfxOn) return;
    try{
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type;
      o.frequency.value = freq;
      o.connect(g); g.connect(audioCtx.destination);
      g.gain.setValueAtTime(0.18, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
      o.start();
      o.stop(audioCtx.currentTime + dur);
    }catch(e){}
  }

  function vibrate(ms){
    if (!vibOn) return;
    if (navigator.vibrate) {
      try { navigator.vibrate(ms); } catch(e){}
    }
  }

  const player = { x: 120, y: 420, vy: 0, onGround: false, frame: 0, frameT: 0 };

  let platforms = [];
  let peaches = [];
  let bgX = 0;

  let trail = [];
  const TRAIL_MAX = 10;

  let popups = [];
  function spawnPopup(x, y, text, color="#ffd700"){
    popups.push({ x, y, text, life: 0.65, color });
  }

  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function rand(a,b){ return a + Math.random()*(b-a); }
  function aabb(ax,ay,aw,ah,bx,by,bw,bh){
    return ax < bx+bw && ax+aw > bx && ay < by+bh && ay+ah > by;
  }

  function resetWorld(){
    timeSec = 0;
    speed = SPEED_MIN;

    distance = 0;
    score = 0;
    bonusScore = 0;

    energy = 0;

    isDashing = false;
    dashLeft = 0;
    dashRiseLeft = 0;

    maxJumps = 2;
    jumpsUsed = 0;
    tripleWindow = false;

    bgX = 0;
    trail = [];
    popups = [];

    player.x = 120;
    player.y = 420;
    player.vy = 0;
    player.onGround = false;
    player.frame = 0;
    player.frameT = 0;

    platforms = [];
    peaches = [];

    const startY = 660;
    platforms.push({ x: -220, y: startY, w: 560, h: PLATFORM_H, kind:"big" });

    let lastX = 340;
    let lastY = startY;

    for(let i=0;i<16;i++){
      const p = genPlatform(lastX, lastY);
      lastX = p.x + p.w;
      lastY = p.y;
      maybeSpawnPeach(p);
    }

    scoreText.textContent = "0";
    updateEnergyUI(true);
    btnDash.disabled = true;
    btnDash.classList.remove("ready");
  }

  function genPlatform(prevRight, prevY){
    const minGap = minGapBySpeed(speed);
    const maxGap = maxGapBySpeed(speed);
    const gap = rand(minGap, maxGap);

    const w = rand(PLATFORM_MIN_W, PLATFORM_MAX_W);

    let dy = rand(-DY_LIMIT, DY_LIMIT);
    if (prevY < 520) dy = Math.abs(dy);
    if (prevY > 740) dy = -Math.abs(dy);

    const y = clamp(prevY + dy, 440, 790);
    const kind = (w > 190) ? "big" : "small";
    const p = { x: prevRight + gap, y, w, h: PLATFORM_H, kind };
    platforms.push(p);
    return p;
  }

  function maybeSpawnPeach(platform){
    if (Math.random() < 0.62){
      peaches.push({ x: platform.x + platform.w*0.55 - 18, y: platform.y - 58, w:36,h:36, type:"small", pulse:0 });
    }
    if (Math.random() < 0.12){
      peaches.push({ x: platform.x + platform.w*0.52 - 28, y: platform.y - 76, w:56,h:56, type:"big", pulse:0 });
    }
  }

  let lastEnergyStep = 0;
  function updateEnergyUI(initial=false){
    const pct = clamp(energy / 100, 0, 1);
    let step = Math.round(pct * 10) * 10;
    step = clamp(step, 0, 100);

    if (!initial && step === 100 && lastEnergyStep < 100){
      energyWrap.classList.remove("flash");
      void energyWrap.offsetWidth;
      energyWrap.classList.add("flash");
      beep(980, 0.06);
      spawnPopup(player.x + PLAYER_W*0.5, player.y - 10, "能量满！", "#ffffff");
    }
    lastEnergyStep = step;

    let key = "energy" + step;
    if (step === 100){
      if (images.energy100a) key = "energy100a";
      else if (images.energy100b) key = "energy100b";
      else key = "energy90";
    } else if (!images[key]){
      let s = step;
      while (s > 0 && !images["energy"+s]) s -= 10;
      if (images["energy"+s]) key = "energy"+s;
    }

    if (energyFrame && images[key]) energyFrame.src = images[key].src;

    const canDash = energy >= DASH_COST;
    btnDash.disabled = !canDash;
    btnDash.classList.toggle("ready", canDash);
  }

  function jump(){
    if (state !== STATE.PLAY) return;
    if (isDashing) return;

    if (player.onGround){
      player.vy = -JUMP_V;
      player.onGround = false;
      jumpsUsed = 1;
      beep(520, .08);
      return;
    }

    if (jumpsUsed < maxJumps){
      player.vy = -EXTRA_JUMP_V;
      jumpsUsed++;
      beep(740, .10, "square");
    }
  }

  function dash(){
    if (state !== STATE.PLAY) return;
    if (isDashing) return;
    if (energy < DASH_COST) return;

    energy -= DASH_COST;
    updateEnergyUI();

    isDashing = true;
    dashLeft = DASH_SEC;
    dashRiseLeft = DASH_RISE_SEC;
    dashTargetY = clamp(player.y - DASH_RISE, 220, 720);

    player.onGround = false;
    jumpsUsed = 0;

    beep(220, .18, "sawtooth");
    spawnPopup(player.x + PLAYER_W*0.5, player.y - 10, "筋斗云！", "#ffffff");
  }

  function finishDash(){
    isDashing = false;
    dashLeft = 0;
    dashRiseLeft = 0;

    tripleWindow = true;
    maxJumps = 3;

    spawnPopup(player.x + PLAYER_W*0.5, player.y - 10, "落地前可三连跳", "#ffffff");
  }

  function gameOver(){
    state = STATE.OVER;
    cancelLoop();

    finalScoreEl.textContent = String(score);
    finalBonusEl.textContent = String(bonusScore);

    const distM = Math.floor(distance / 10);
    finalDistEl.textContent = String(distM);

    if (score > bestScore){
      bestScore = score;
      localStorage.setItem("dasheng-best", String(bestScore));
    }
    bestScoreEl.textContent = String(bestScore);

    if (score >= bestScore){
      diffBestEl.textContent = "新纪录！";
    } else {
      diffBestEl.textContent = `还差 ${bestScore - score} 分超过最高分`;
    }

    show(panelOver);
  }

  function update(dt){
    timeSec += dt;

    speed = (timeSec < SPEED_UP_SEC)
      ? SPEED_MIN + (SPEED_MAX - SPEED_MIN) * (timeSec / SPEED_UP_SEC)
      : SPEED_MAX;

    const curSpeed = isDashing ? DASH_SPEED : speed;

    distance += curSpeed * dt;
    score = Math.floor(distance / 10) + bonusScore;
    scoreText.textContent = String(score);

    bgX += curSpeed * 0.18 * dt;

    if (!tutorialDone && state === STATE.PLAY){
      tutorialTimer += dt;
      if (tutorialStage === 0){
        showToast("点击屏幕跳跃（可二段跳）");
        if (tutorialTimer > 2.2){ tutorialStage = 1; tutorialTimer = 0; }
      } else if (tutorialStage === 1){
        showToast("吃桃子攒能量，满了点「筋斗云」冲刺");
        if (tutorialTimer > 2.6){ tutorialStage = 2; tutorialTimer = 0; }
      } else {
        showToast("冲刺时吃桃子加分：小桃+10 / 金桃+50");
        if (tutorialTimer > 2.8){
          hideToast();
          tutorialDone = true;
          localStorage.setItem("dasheng-tutorial-done","1");
        }
      }
    } else {
      hideToast();
    }

    if (isDashing){
      trail.unshift({ x: player.x, y: player.y, life: 0.35 });
      if (trail.length > TRAIL_MAX) trail.pop();

      if (dashRiseLeft > 0){
        dashRiseLeft -= dt;
        const t = 1 - clamp(dashRiseLeft / DASH_RISE_SEC, 0, 1);
        player.y = player.y + (dashTargetY - player.y) * (0.18 + 0.82*t);
      } else {
        player.vy = 0;
        player.y = clamp(player.y, 220, 760);
      }

      dashLeft -= dt;
      if (dashLeft <= 0){
        finishDash();
      }
    } else {
      player.vy += GRAVITY * dt;
      if (player.vy > MAX_FALL) player.vy = MAX_FALL;
      player.y += player.vy * dt;
    }

    player.frameT += dt;
    if (player.frameT > 0.12){
      player.frame = (player.frame + 1) % 3;
      player.frameT = 0;
    }

    for(let i=platforms.length-1;i>=0;i--){
      const p = platforms[i];
      p.x -= curSpeed * dt;
      if (p.x + p.w < -320) platforms.splice(i,1);
    }

    const last = platforms[platforms.length-1];
    if (last && last.x + last.w < W + 260){
      const p = genPlatform(last.x + last.w, last.y);
      maybeSpawnPeach(p);
    }

    for(let i=peaches.length-1;i>=0;i--){
      const pe = peaches[i];
      pe.x -= curSpeed * dt;
      pe.pulse += dt;

      if (isDashing){
        const px = player.x + PLAYER_W*0.5;
        const py = player.y + PLAYER_H*0.4;
        const cx = pe.x + pe.w*0.5;
        const cy = pe.y + pe.h*0.5;
        const dx = px - cx;
        const dy = py - cy;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < 420){
          pe.x += dx * 6.0 * dt;
          pe.y += dy * 6.0 * dt;
        }
      }

      if (pe.x + pe.w < -220) peaches.splice(i,1);
    }

    for(let i=popups.length-1;i>=0;i--){
      const p = popups[i];
      p.life -= dt;
      p.y -= 32 * dt;
      if (p.life <= 0) popups.splice(i,1);
    }

    for(let i=trail.length-1;i>=0;i--){
      trail[i].life -= dt;
      if (trail[i].life <= 0) trail.splice(i,1);
    }

    player.onGround = false;
    const pb = player.y + PLAYER_H;
    const pr = player.x + PLAYER_W;

    for (let i=0;i<platforms.length;i++){
      const p = platforms[i];
      if (pr < p.x || player.x > p.x + p.w) continue;

      if (pb > p.y && pb < p.y + 20 && player.vy >= 0){
        player.y = p.y - PLAYER_H;
        player.vy = 0;
        player.onGround = true;

        if (tripleWindow){
          tripleWindow = false;
          maxJumps = 2;
          spawnPopup(player.x + PLAYER_W*0.5, player.y - 10, "回到二连跳", "#ffffff");
        }
        jumpsUsed = 0;
        break;
      }
    }

    for(let i=peaches.length-1;i>=0;i--){
      const pe = peaches[i];
      if (aabb(player.x,player.y,PLAYER_W,PLAYER_H, pe.x,pe.y,pe.w,pe.h)){

        if (isDashing) {
          const add = (pe.type === "big") ? DASH_BONUS_BIG : DASH_BONUS_SMALL;
          bonusScore += add;
          spawnPopup(pe.x + pe.w*0.5, pe.y, `+${add}`, "#ffd700");
          beep(pe.type === "big" ? 980 : 860, .06);
          vibrate(pe.type === "big" ? 18 : 10);
        } else {
          const addE = (pe.type === "big") ? ENERGY_FROM_BIG : ENERGY_FROM_SMALL;
          energy = clamp(energy + addE, 0, 100);
          spawnPopup(pe.x + pe.w*0.5, pe.y, `能量+${addE}`, "#ffffff");
          beep(pe.type === "big" ? 980 : 860, .06);
          updateEnergyUI();
        }

        peaches.splice(i, 1);
      }
    }

    if (player.y > H + 120){
      gameOver();
    }
  }

  function drawBackground(){
    const bg = images.background;
    if (!bg){
      ctx.fillStyle = "#102a43";
      ctx.fillRect(0,0,W,H);
      return;
    }
    const bw = bg.width || 1;
    const bh = bg.height || 1;
    const scale = Math.max(W / bw, H / bh);
    const dw = bw * scale;
    const dh = bh * scale;
    const ox = (W - dw) * 0.5;
    const oy = (H - dh) * 0.5;

    const sx = ((bgX % bw) + bw) % bw;

    ctx.drawImage(bg, sx, 0, bw - sx, bh, ox, oy, (bw - sx)*scale, dh);
    ctx.drawImage(bg, 0, 0, sx, bh, ox + (bw - sx)*scale, oy, sx*scale, dh);
  }

  function drawPlatforms(){
    const big = images.platformBig;
    const small = images.platformSmall;
    for(const p of platforms){
      const img = (p.kind==="big") ? big : small;
      if (img) ctx.drawImage(img, p.x, p.y, p.w, p.h);
      else { ctx.fillStyle="#fff"; ctx.fillRect(p.x,p.y,p.w,p.h); }
    }
  }

  function drawPeaches(){
    const small = images.peach;
    const big = images.bigPeach;
    for(const pe of peaches){
      const img = (pe.type==="big") ? big : small;
      if (img){
        if (pe.type==="big"){
          const pulse = 1 + 0.08*Math.sin(pe.pulse*10);
          ctx.save();
          ctx.translate(pe.x+pe.w/2, pe.y+pe.h/2);
          ctx.scale(pulse,pulse);
          ctx.drawImage(img, -pe.w/2, -pe.h/2, pe.w, pe.h);
          ctx.restore();
        } else {
          ctx.drawImage(img, pe.x, pe.y, pe.w, pe.h);
        }
      } else {
        ctx.fillStyle = pe.type==="big" ? "#ffd700" : "#ff77aa";
        ctx.fillRect(pe.x,pe.y,pe.w,pe.h);
      }
    }
  }

  function drawSpeedLines(){
    if (!isDashing) return;
    ctx.save();
    ctx.globalAlpha = 0.18;
    ctx.lineWidth = 3;
    ctx.strokeStyle = "#ffffff";
    for(let i=0;i<10;i++){
      const y = rand(120, H-120);
      const len = rand(60, 160);
      const x2 = rand(80, W-20);
      const x1 = x2 - len;
      ctx.beginPath();
      ctx.moveTo(x1, y);
      ctx.lineTo(x2, y);
      ctx.stroke();
    }
    ctx.restore();
  }

  function drawPopups(){
    if (popups.length === 0) return;
    ctx.save();
    ctx.font = "bold 18px system-ui, -apple-system, PingFang SC, Microsoft YaHei";
    ctx.textAlign = "center";
    for(const p of popups){
      const alpha = clamp(p.life / 0.65, 0, 1);
      ctx.globalAlpha = alpha;
      ctx.fillStyle = p.color;
      ctx.shadowColor = "rgba(0,0,0,.45)";
      ctx.shadowBlur = 8;
      ctx.fillText(p.text, p.x, p.y);
    }
    ctx.restore();
  }

  function drawPlayer(){
    const drawW = PLAYER_DRAW_W;
    const drawH = PLAYER_DRAW_H;

    const baseDrawX = player.x + PLAYER_W * 0.5 - drawW * 0.5;
    const baseDrawY = player.y + PLAYER_H - drawH + FOOT_OFFSET;

    const img0 = images.player1;
    const img1 = images.player2;
    const img2 = images.player3;

    if (isDashing && trail.length){
      ctx.save();
      for(let i=0;i<trail.length;i++){
        const tr = trail[i];
        const a = clamp(tr.life / 0.35, 0, 1) * 0.28;
        ctx.globalAlpha = a;
        ctx.shadowColor = "#ffd700";
        ctx.shadowBlur = 10;
        const img = (player.frame===0)?img0:((player.frame===1)?img1:img2);
        if (img){
          const x = tr.x + PLAYER_W * 0.5 - drawW * 0.5 - i*3;
          const y = tr.y + PLAYER_H - drawH + FOOT_OFFSET;
          ctx.drawImage(img, x, y, drawW, drawH);
        }
      }
      ctx.restore();
    }

    const img = (player.frame===0)?img0:((player.frame===1)?img1:img2);

    if (img){
      if (isDashing){
        ctx.save();
        ctx.globalAlpha = 0.95;
        ctx.shadowColor = "#ffd700";
        ctx.shadowBlur = 16;
        ctx.drawImage(img, baseDrawX, baseDrawY, drawW, drawH);
        ctx.restore();
      } else {
        ctx.drawImage(img, baseDrawX, baseDrawY, drawW, drawH);
      }
    } else {
      ctx.fillStyle="#ffd700";
      ctx.fillRect(player.x,player.y,PLAYER_W,PLAYER_H);
    }
  }

  function render(){
    ctx.clearRect(0,0,W,H);
    drawBackground();
    drawSpeedLines();
    drawPlatforms();
    drawPeaches();
    drawPlayer();
    drawPopups();
  }

  function loop(t){
    if (!lastT) lastT = t;
    const dt = Math.min((t - lastT)/1000, 0.05);
    lastT = t;

    if (state === STATE.PLAY){
      update(dt);
    } else if (state === STATE.COUNTDOWN){
      countdownLeft -= dt;

      if (countdownLeft > 0){
        const showNum = Math.ceil(countdownLeft);
        if (countdownShown !== showNum){
          countdownShown = showNum;
          countdownText.textContent = String(showNum);
          countdownHint.textContent = "准备开始";
          beep(420 + (3-showNum)*120, 0.05);
        }
      } else if (goLeft > 0){
        goLeft -= dt;
        countdownText.textContent = "GO!";
        countdownHint.textContent = "冲！";
      } else {
        hide(panelCountdown);
        state = STATE.PLAY;
      }
    }

    render();
    rafId = requestAnimationFrame(loop);
  }

  function startLoop(){
    cancelLoop();
    lastT = 0;
    rafId = requestAnimationFrame(loop);
  }
  function cancelLoop(){
    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;
  }

  function show(el){ el.classList.remove("hidden"); }
  function hide(el){ el.classList.add("hidden"); }
  function hideAllPanels(){
    hide(panelStart); hide(panelHow); hide(panelPause); hide(panelOver); hide(panelSettings); hide(panelCountdown);
  }

  function enterMenu(){
    state = STATE.MENU;
    hideAllPanels();
    show(panelStart);
  }

  let countdownLeft = 0;
  let countdownShown = 3;
  let goLeft = 0;

  function startGame(){
    hideAllPanels();

    tutorialTimer = 0;
    tutorialStage = 0;

    resetWorld();

    state = STATE.COUNTDOWN;
    countdownLeft = 3.0;
    countdownShown = 3;
    goLeft = 0.45;
    countdownText.textContent = "3";
    countdownHint.textContent = "准备开始";
    show(panelCountdown);

    startLoop();
  }

  function pauseGame(){
    if (state !== STATE.PLAY) return;
    state = STATE.PAUSE;
    show(panelPause);
  }
  function resumeGame(){
    if (state !== STATE.PAUSE) return;
    hide(panelPause);
    state = STATE.PLAY;
  }

  function shareScore(){
    const text = `我在《大圣跑酷》中获得了 ${score} 分（冲刺加分 ${bonusScore}）！快来挑战我吧！`;
    if (navigator.clipboard){
      navigator.clipboard.writeText(text).then(() => alert("已复制分享文案到剪贴板！"));
    } else {
      alert(text);
    }
  }

  function updateTopIcons(){
    if (images.pauseIcon) pauseIconImg.src = images.pauseIcon.src;
    if (images.settingsIcon) settingsIconImg.src = images.settingsIcon.src;
    soundIconImg.src = sfxOn ? (images.soundOn?.src || "") : (images.soundOff?.src || "");
  }

  canvas.addEventListener("pointerdown", () => {
    if (state === STATE.PLAY) jump();
  });

  btnStart.addEventListener("click", startGame);
  btnHow.addEventListener("click", () => { hide(panelStart); show(panelHow); });
  btnBackFromHow.addEventListener("click", () => { hide(panelHow); show(panelStart); });

  btnPause.addEventListener("click", () => {
    if (state === STATE.PLAY) pauseGame();
    else if (state === STATE.PAUSE) resumeGame();
  });

  btnSettings.addEventListener("click", () => {
    if (state === STATE.PLAY) pauseGame();
    show(panelSettings);
  });

  btnSound.addEventListener("click", () => {
    sfxOn = !sfxOn;
    localStorage.setItem("dasheng-sfx", sfxOn ? "1" : "0");
    toggleSfx.classList.toggle("on", sfxOn);
    updateTopIcons();
  });

  btnDash.addEventListener("click", dash);

  btnResume.addEventListener("click", resumeGame);
  btnRestart.addEventListener("click", startGame);
  btnExit.addEventListener("click", () => { cancelLoop(); enterMenu(); });

  btnCloseSettings.addEventListener("click", () => { hide(panelSettings); });

  toggleSfx.addEventListener("click", () => {
    sfxOn = !sfxOn;
    localStorage.setItem("dasheng-sfx", sfxOn ? "1" : "0");
    toggleSfx.classList.toggle("on", sfxOn);
    updateTopIcons();
  });

  toggleBgm.addEventListener("click", () => {
    bgmOn = !bgmOn;
    localStorage.setItem("dasheng-bgm", bgmOn ? "1" : "0");
    toggleBgm.classList.toggle("on", bgmOn);
  });

  toggleVib.addEventListener("click", () => {
    vibOn = !vibOn;
    localStorage.setItem("dasheng-vib", vibOn ? "1" : "0");
    toggleVib.classList.toggle("on", vibOn);
    spawnPopup(player.x + PLAYER_W*0.5, player.y - 10, vibOn ? "震动：开" : "震动：关", "#ffffff");
    if (vibOn) vibrate(12);
  });

  btnPlayAgain.addEventListener("click", startGame);
  btnShare.addEventListener("click", shareScore);
  btnBackMenu.addEventListener("click", () => { enterMenu(); });

  window.addEventListener("keydown", (e) => {
    if (e.code === "Space"){ e.preventDefault(); jump(); }
    if (e.code === "KeyD"){ dash(); }
    if (e.code === "KeyP"){
      if (state === STATE.PLAY) pauseGame();
      else if (state === STATE.PAUSE) resumeGame();
    }
  });

  (async function init(){
    bestScoreEl.textContent = String(bestScore);

    hideAllPanels();
    show(panelLoading);
    setLoadingProgress(0, Object.keys(imageSources).length);

    await loadImages((done, total, key, ok) => {
      setLoadingProgress(done, total, key, ok);
    });

    hide(panelLoading);

    // ✅ 根据角色贴图真实宽高比计算显示宽度（避免压扁）
    syncPlayerDrawSize();

    if (images.coverHero) coverHero.src = images.coverHero.src;
    if (images.background) coverImg.src = images.background.src;

    updateTopIcons();
    updateEnergyUI(true);

    startLoop();
    enterMenu();
  })();

})();
</script>
</body>
</html>